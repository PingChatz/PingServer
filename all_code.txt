===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/MainApplication.java =====
package chat.ping.main;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

// Starting point of the application
@SpringBootApplication
public class MainApplication
{

	public static void main(String[] args)
	{
		SpringApplication.run(MainApplication.class, args);
	}
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/config/SecurityFilterConfig.java =====
package chat.ping.main.config;


import chat.ping.main.infrastructure.security.JWTAuthFilter;
import chat.ping.main.infrastructure.security.UserDetailsServiceImplementation;
import chat.ping.main.config.SecurityConfig.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityFilterConfig
{

    private final JWTAuthFilter jwtAuthFilter;
    private final UserDetailsServiceImplementation userDetailsService;
    private final PasswordEncoder passwordEncoder;

    public SecurityFilterConfig(JWTAuthFilter jwtAuthFilter, UserDetailsServiceImplementation userDetailsService, PasswordEncoder passwordEncoder)
    {
        this.jwtAuthFilter = jwtAuthFilter;
        this.userDetailsService = userDetailsService;
        this.passwordEncoder = passwordEncoder;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception
    {
        http
                .csrf(AbstractHttpConfigurer::disable) // disable CSRF
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) // stateless session
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/v1/auth/**").permitAll()
                        .requestMatchers("/api/hello").permitAll()
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                        .anyRequest().authenticated() // All other requests require authentication
                )
                .authenticationProvider(authenticationProvider())
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public AuthenticationProvider authenticationProvider()
    {
        DaoAuthenticationProvider authenticationProvider = new DaoAuthenticationProvider();
        authenticationProvider.setUserDetailsService(userDetailsService);
        authenticationProvider.setPasswordEncoder(passwordEncoder);
        return authenticationProvider;
    }

}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/config/SecurityConfig.java =====
package chat.ping.main.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;


@Configuration
public class SecurityConfig
{
    @Bean
    public PasswordEncoder passwordEncoder()
    {
        return new BCryptPasswordEncoder();
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/config/AppConfig.java =====
package chat.ping.main.config;


import chat.ping.main.entity.user.UserFactory;
import chat.ping.main.infrastructure.auth.presenter.UserRegisterPresenter;
import chat.ping.main.infrastructure.auth.gateway.UserAuthDsGateway;
import chat.ping.main.infrastructure.security.JWTUtils;
import chat.ping.main.usecase.auth.login.UserLoginInteractor;
import chat.ping.main.usecase.auth.register.UserRegisterInteractor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class AppConfig
{
    @Bean
    public UserRegisterPresenter userRegisterPresenter()
    {
        return new UserRegisterPresenter();
    }

    @Bean
    public UserRegisterInteractor userRegisterInteractor(UserAuthDsGateway userAuthDsGateway,
                                                         UserRegisterPresenter userRegisterPresenter,
                                                         UserFactory userFactory)
    {
        return new UserRegisterInteractor(
                userAuthDsGateway,
                userRegisterPresenter,
                userFactory
        );
    }

    @Bean
    public UserLoginPresenter userLoginPresenter()
    {
        return new UserLoginPresenter();
    }

    @Bean
    public UserLoginInteractor userLoginInteractor(UserAuthDsGateway userAuthDsGateway,
                                                   PasswordEncoder passwordEncoder,
                                                   UserLoginPresenter userLoginPresenter,
                                                   JWTUtils jwtUtils)
    {
        return new UserLoginInteractor(
                userAuthDsGateway,
                passwordEncoder,
                userLoginPresenter,
                jwtUtils
        );
    }

    @Bean
    public UserFactory userFactory(PasswordEncoder passwordEncoder)
    {
        return new UserFactory(passwordEncoder);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/entity/user/User.java =====
package chat.ping.main.entity.user;

public class User
{

    // properties
    private final String email;
    private final String username;
    private final String passwordHash;

    // Constructor
    public User(String email, String username, String passwordHash)
    {
        this.email = email;
        this.username = username;
        this.passwordHash = passwordHash;
    }

    public String getEmail()
    {
        return email;
    }

    public String getUsername()
    {
        return username;
    }

    public String getPasswordHash()
    {
        return passwordHash;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/entity/user/UserFactory.java =====
package chat.ping.main.entity.user;

import org.springframework.security.crypto.password.PasswordEncoder;


public class UserFactory
{
    private final PasswordEncoder passwordEncoder;

    public UserFactory(PasswordEncoder passwordEncoder)
    {
        this.passwordEncoder = passwordEncoder;
    }

    public User createUser(String email, String username, String password)
    {
        String hashedPassword = passwordEncoder.encode(password);
        return new User(email, username, hashedPassword);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/util/JsonUtil.java =====
package chat.ping.main.shared.util;

public class JsonUtil
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/util/DateFormatter.java =====
package chat.ping.main.shared.util;

public class DateFormatter
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/error/GlobalExceptionHandler.java =====
package chat.ping.main.shared.error;

import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
@Order(Ordered.LOWEST_PRECEDENCE)
public class GlobalExceptionHandler
{
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericException(Exception ex) {
        ErrorResponse errorResponse = new ErrorResponse(
                "InternalServerError",
                "An unexpected error occurred."
        );
        return new ResponseEntity<>(errorResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/error/ErrorResponse.java =====
package chat.ping.main.shared.error;

public class ErrorResponse
{
    private String error;
    private String message;

    public ErrorResponse(String error, String message)
    {
        this.error = error;
        this.message = message;
    }

    // Getters and Setters
    public String getError() {
        return error;
    }

    public void setError(String error) {
        this.error = error;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/validation/CredentialsValidator.java =====
package chat.ping.main.shared.validation;

public class CredentialsValidator
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/validation/UniqueUsernameValidator.java =====
package chat.ping.main.shared.validation;

public class UniqueUsernameValidator
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/validation/EmailValidator.java =====
package chat.ping.main.shared.validation;

import chat.ping.main.entity.user.exception.InvalidCredentialsException;

import java.util.regex.Pattern;

public class EmailValidator
{
    // Regular expression for email validation
    private static final String EMAIL_REGEX = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$";
    private static final Pattern EMAIL_PATTERN = Pattern.compile(EMAIL_REGEX);

    /**
     * Checks if the given string is a valid email.
     *
     * @param email The email to validate.
     * @return True if valid, false otherwise.
     */
    public static boolean isValid(String email)
    {
        if (email == null || email.trim().isEmpty())
        {
            return false;
        }
        return EMAIL_PATTERN.matcher(email).matches();
    }

    /**
     * Validates the email and throws an exception if invalid.
     *
     * @param email The email to validate.
     * @throws InvalidCredentialsException if email is invalid.
     */
    public static void validate(String email)
    {
        if (!isValid(email))
        {
            throw new InvalidCredentialsException("Invalid email format.");
        }
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/shared/validation/PasswordValidator.java =====
package chat.ping.main.shared.validation;

import chat.ping.main.entity.user.exception.InvalidPasswordException;

import java.util.regex.Pattern;

public class PasswordValidator
{
    // Define password rules
    private static final int MIN_LENGTH = 8;
    private static final int MAX_LENGTH = 32;
    private static final String SPECIAL_CHARACTER_REGEX = "[^a-zA-Z0-9]";
    private static final String DIGIT_REGEX = "\\d";
    private static final String UPPERCASE_REGEX = "[A-Z]";
    private static final String LOWERCASE_REGEX = "[a-z]";

    public static boolean isValid(String password) {
        // Null or empty check
        if (password == null || password.trim().isEmpty()) {
            throw new InvalidPasswordException("Password cannot be empty.");
        }

        // Length validation
        if (password.length() < MIN_LENGTH || password.length() > MAX_LENGTH) {
            throw new InvalidPasswordException("Password must be between " + MIN_LENGTH + " and " + MAX_LENGTH + " characters.");
        }

        // Special character validation
        if (!Pattern.compile(SPECIAL_CHARACTER_REGEX).matcher(password).find()) {
            throw new InvalidPasswordException("Password must contain at least one special character.");
        }

        // Digit validation
        if (!Pattern.compile(DIGIT_REGEX).matcher(password).find()) {
            throw new InvalidPasswordException("Password must contain at least one digit.");
        }

        // Uppercase letter validation
        if (!Pattern.compile(UPPERCASE_REGEX).matcher(password).find()) {
            throw new InvalidPasswordException("Password must contain at least one uppercase letter.");
        }

        // Lowercase letter validation
        if (!Pattern.compile(LOWERCASE_REGEX).matcher(password).find()) {
            throw new InvalidPasswordException("Password must contain at least one lowercase letter.");
        }

        return true;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/helloWorld/HelloWorldController.java =====
package chat.ping.main.infrastructure.helloWorld;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloWorldController
{
    @GetMapping("/api/hello")
    public String helloWorld()
    {
        return "Hello, World!";
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/security/JWTUtils.java =====
package chat.ping.main.infrastructure.security;

import chat.ping.main.infrastructure.security.exception.InvalidTokenException;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.Date;
import java.util.Map;
import java.util.function.Function;

@Component
public class JWTUtils
{

    @Value("${jwt.secret}")
    private String secret;

    @Value("${jwt.expiration}")
    private long jwtExpiration;

    public String generateToken(@NotNull String username,  Map<String, Object> claims)
    {
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + jwtExpiration))
                .signWith(Keys.hmacShaKeyFor(Decoders.BASE64.decode(secret)), SignatureAlgorithm.HS256)
                .compact();
    }

    public String extractUserName(@NotNull String token)
    {

        return extractClaim(token, Claims::getSubject);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver)
    {
        Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    private Claims extractAllClaims(String token)
    {
        try
        {
            return Jwts.parserBuilder()
                    .setSigningKey(Keys.hmacShaKeyFor(Decoders.BASE64.decode(secret)))
                    .build()
                    .parseClaimsJws(token)
                    .getBody();
        }
        catch (JwtException e)
        {
            throw new InvalidTokenException("Invalid JWT Token");
        }

    }

    public boolean isTokenValid(String token, String username)
    {
        if (!(username.equals(extractUserName(token)) && !isTokenExpired(token)))
        {
            throw new InvalidTokenException("Token Validation Failed: " + token);
        }
        return true;
    }

    private boolean isTokenExpired(String token)
    {
        return extractAllClaims(token).getExpiration().before(new Date());
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/security/JWTAuthFilter.java =====
package chat.ping.main.infrastructure.security;


import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
public class JWTAuthFilter extends OncePerRequestFilter
{

    private final JWTUtils jwtUtils;
    private final UserDetailsService userDetailsService;

    public JWTAuthFilter(JWTUtils jwtUtils, UserDetailsService userDetailsService)
    {
        this.jwtUtils = jwtUtils;
        this.userDetailsService = userDetailsService;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException
    {
        // collect the authorization header
        String authorizationHeader = request.getHeader("Authorization");

        // make sure the response is valid
        if (authorizationHeader == null || !authorizationHeader.startsWith("Bearer "))
        {
            filterChain.doFilter(request, response);
            return;
        }

        // collect the token and extract the user id
        String jwtToken = authorizationHeader.substring(7);
        String username = jwtUtils.extractUserName(jwtToken);

        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null)
        {
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);

            // make sure token is valid
            if (jwtUtils.isTokenValid(jwtToken, username))
            {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());

                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }

        filterChain.doFilter(request, response);

    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/security/exception/InvalidTokenException.java =====
package chat.ping.main.infrastructure.security.exception;

public class InvalidTokenException extends RuntimeException
{
    public InvalidTokenException(String message)
    {
        super(message);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/security/UserDetailsServiceImplementation.java =====
package chat.ping.main.infrastructure.security;

import chat.ping.main.entity.user.exception.UserNotFoundException;
import chat.ping.main.infrastructure.auth.gateway.JpaUserRepository;
import chat.ping.main.infrastructure.auth.gateway.UserDataMapper;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.security.core.userdetails.User;

@Service
public class UserDetailsServiceImplementation implements UserDetailsService {

    private final JpaUserRepository userRepository;

    public UserDetailsServiceImplementation(JpaUserRepository userRepository)
    {
        this.userRepository = userRepository;
    }

    /**
     * Loads user-specific data by username or email for Spring Security.
     *
     * @param username The username provided during login.
     * @return UserDetails containing user information (username, password, authorities).
     * @throws UsernameNotFoundException if no user is found with the provided username/email.
     */
    @Override
    public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException
    {
        // Attempt to find user by username or email
        UserDataMapper user = userRepository.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("User not found with Username: " + username));

        // Return UserDetails object expected by Spring Security
        return User.builder()
                .username(user.getUsername())
                .password(user.getPasswordHash()) // Password must be hashed
                .authorities("ROLE_USER") // Default role, can be adjusted based on user data
                .build();
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/presenter/UserRegisterPresenter.java =====
package chat.ping.main.infrastructure.auth.presenter;

import chat.ping.main.entity.user.User;
import chat.ping.main.shared.error.ErrorResponse;
import chat.ping.main.usecase.auth.dto.UserRegisterResponseModel;
import chat.ping.main.usecase.auth.register.UserRegisterOutputBoundary;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;

@Component
public class UserRegisterPresenter implements UserRegisterOutputBoundary
{

    private ResponseEntity<?> responseEntity;

    @Override
    public void prepareSuccessView(User user)
    {
        UserRegisterResponseModel responseModel = new UserRegisterResponseModel(
                user.getUsername(),
                "User registered successfully!"
        );
        this.responseEntity = ResponseEntity.status(HttpStatus.CREATED).body(responseModel);
    }

    @Override
    public void prepareUsernameAlreadyExistsView(String username) {
        ErrorResponse errorResponse = new ErrorResponse(
                "UsernameAlreadyExists",
                "The username '" + username + "' is already taken."
        );
        this.responseEntity = ResponseEntity.status(HttpStatus.CONFLICT).body(errorResponse);
    }

    @Override
    public void prepareEmailAlreadyExistsView(String email) {
        ErrorResponse errorResponse = new ErrorResponse(
                "EmailAlreadyExists",
                "The email '" + email + "' is already registered."
        );
        this.responseEntity = ResponseEntity.status(HttpStatus.CONFLICT).body(errorResponse);
    }

    @Override
    public void prepareInvalidPasswordView(String errorMessage) {
        ErrorResponse errorResponse = new ErrorResponse("InvalidPassword", errorMessage);
        this.responseEntity = ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
    }

    @Override
    public void prepareInvalidEmailFormatView(String email) {
        ErrorResponse errorResponse = new ErrorResponse(
                "InvalidEmailFormat",
                "The email '" + email + "' is not in a valid format."
        );
        this.responseEntity = ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
    }

    public ResponseEntity<?> getResponseEntity() {
        return responseEntity;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/presenter/UserLoginPresenter.java =====
package chat.ping.main.infrastructure.auth.presenter;

import chat.ping.main.shared.error.ErrorResponse;
import chat.ping.main.usecase.auth.dto.UserLoginResponseModel;
import chat.ping.main.usecase.auth.login.UserLoginOutputBoundary;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

public class UserLoginPresenter implements UserLoginOutputBoundary
{
    private ResponseEntity<?> responseEntity;

    @Override
    public void prepareSuccessView(String authToken, String username)
    {

        UserLoginResponseModel userLoginResponseModel = new UserLoginResponseModel(authToken,
                 username, "Login Successful!");

        this.responseEntity = ResponseEntity.status(HttpStatus.OK).body(userLoginResponseModel);
    }

    @Override
    public void prepareInvalidCredentialsView(String errorMessage)
    {
        ErrorResponse errorResponse = new ErrorResponse("Invalid Credentials", "Login Unsuccessful " +
                "due to invalid credentials");
        this.responseEntity = ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);

    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/controller/UserLoginController.java =====
package chat.ping.main.infrastructure.auth.controller;


import chat.ping.main.usecase.auth.dto.UserLoginRequestModel;
import chat.ping.main.usecase.auth.dto.UserLoginResponseModel;
import chat.ping.main.usecase.auth.login.UserLoginInputBoundary;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/auth")
public class UserLoginController
{
    private final UserLoginInputBoundary userLoginInputBoundary;

    @Autowired
    public UserLoginController(UserLoginInputBoundary userLoginInputBoundary)
    {
        this.userLoginInputBoundary = userLoginInputBoundary;
    }

    @PostMapping("/login")
    public ResponseEntity<UserLoginResponseModel> login(@RequestBody UserLoginRequestModel requestModel)
    {
        UserLoginResponseModel response = userLoginInputBoundary.login(requestModel);

        return ResponseEntity.ok(response);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/controller/UserRegisterController.java =====
package chat.ping.main.infrastructure.auth.controller;

import chat.ping.main.infrastructure.auth.presenter.UserRegisterPresenter;
import chat.ping.main.usecase.auth.dto.UserRegisterRequestModel;
import chat.ping.main.usecase.auth.dto.UserRegisterResponseModel;
import chat.ping.main.usecase.auth.register.UserRegisterInputBoundary;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/auth")
public class UserRegisterController
{
    private final UserRegisterInputBoundary userRegisterInputBoundary;
    private final UserRegisterPresenter presenter;

    @Autowired
    public UserRegisterController(UserRegisterInputBoundary userRegisterInputBoundary,
                                  UserRegisterPresenter presenter)
    {
        this.userRegisterInputBoundary = userRegisterInputBoundary;
        this.presenter = presenter;
    }

    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody UserRegisterRequestModel requestModel)
    {
        userRegisterInputBoundary.register(requestModel);

        return presenter.getResponseEntity();
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/formatter/UserLoginResponseFormatter.java =====
package chat.ping.main.infrastructure.auth.formatter;

public class UserLoginResponseFormatter
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/formatter/UserRegisterResponseFormatter.java =====
package chat.ping.main.infrastructure.auth.formatter;

public class UserRegisterResponseFormatter
{
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/gateway/JpaUserRepository.java =====
package chat.ping.main.infrastructure.auth.gateway;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface JpaUserRepository extends JpaRepository<UserDataMapper, Long>
{
    boolean existsByUsername(String username);

    boolean existsByEmail(String email);

    Optional<UserDataMapper> findByUsername(String username);

    Optional<UserDataMapper> findByEmail(String email);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/gateway/UserDataMapper.java =====
package chat.ping.main.infrastructure.auth.gateway;

import jakarta.persistence.*;

import static jakarta.persistence.GenerationType.SEQUENCE;

@Entity
@Table(name = "users")
public class UserDataMapper
{
    @Id
    @SequenceGenerator(name = "user_sequence", sequenceName = "user_sequence", allocationSize = 1)
    @GeneratedValue(strategy = SEQUENCE, generator = "user_sequence")
    @Column(name = "user_id", updatable = false, nullable = false)
    private Long id;

    @Column(name="username", nullable = false, unique = true)
    private String username;

    @Column(name="email", nullable = false, unique = true)
    private String email;

    @Column(name="password_hash", nullable = false)
    private String passwordHash;


    // Constructors
    public UserDataMapper()
    {
    }

    public UserDataMapper(String email, String username, String passwordHash)
    {
        this.email = email;
        this.username = username;
        this.passwordHash = passwordHash;
    }

    public Long getId()
    {
        return id;
    }

    public String getUsername()
    {
        return username;
    }

    public String getEmail()
    {
        return email;
    }

    public String getPasswordHash()
    {
        return passwordHash;
    }

}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/gateway/JpaUserGateway.java =====
package chat.ping.main.infrastructure.auth.gateway;

import chat.ping.main.entity.user.User;
import org.springframework.stereotype.Component;

import java.util.Optional;

@Component
public class JpaUserGateway implements UserAuthDsGateway
{
    private final JpaUserRepository userRepository;

    public JpaUserGateway(JpaUserRepository userRepository)
    {
        this.userRepository = userRepository;
    }

    @Override
    public boolean existsByUsername(String username)
    {
        return userRepository.existsByUsername(username);
    }

    @Override
    public boolean existsByEmail(String email)
    {
        return userRepository.existsByEmail(email);
    }

    @Override
    public Optional<User> findByUsername(String username)
    {
        return userRepository.findByUsername(username)
                .map(userDataMapper -> new User(
                        userDataMapper.getEmail(),
                        userDataMapper.getUsername(),
                        userDataMapper.getPasswordHash()
                ));
    }

    @Override
    public Optional<User> findByEmail(String email)
    {
        return userRepository.findByEmail(email)
                .map(userDataMapper -> new User(
                        userDataMapper.getEmail(),
                        userDataMapper.getUsername(),
                        userDataMapper.getPasswordHash()
                ));
    }

    @Override
    public void save(User user)
    {
        UserDataMapper userDataMapper = new UserDataMapper(user.getEmail(), user.getUsername(), user.getPasswordHash());
        userRepository.save(userDataMapper);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/infrastructure/auth/gateway/UserAuthDsGateway.java =====
package chat.ping.main.infrastructure.auth.gateway;


import chat.ping.main.entity.user.User;

import java.util.Optional;

public interface UserAuthDsGateway
{
    boolean existsByUsername(String username);

    boolean existsByEmail(String email);

    Optional<User> findByUsername(String username);

    Optional<User> findByEmail(String email);

    void save(User user);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/dto/UserRegisterRequestModel.java =====
package chat.ping.main.usecase.auth.dto;

public class UserRegisterRequestModel
{
    private final String username;
    private final String password;
    private final String email;

    public UserRegisterRequestModel(String username, String password, String email)
    {
        this.username = username;
        this.password = password;
        this.email = email;
    }

    public String getUsername()
    {
        return username;
    }

    public String getEmail()
    {
        return email;
    }

    public String getPassword()
    {
        return password;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/dto/UserRegisterResponseModel.java =====
package chat.ping.main.usecase.auth.dto;

public class UserRegisterResponseModel
{

    private final String username;
    private final String message;

    public UserRegisterResponseModel(String username, String message)
    {
        this.username = username;
        this.message = message;
    }

    public String getUsername()
    {
        return username;
    }

    public String getMessage()
    {
        return message;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/dto/UserLoginRequestModel.java =====
package chat.ping.main.usecase.auth.dto;

public class UserLoginRequestModel
{
    private final String usernameOrEmail;
    private final String password;


    public UserLoginRequestModel(String usernameOrEmail, String password)
    {
        this.usernameOrEmail = usernameOrEmail;
        this.password = password;
    }

    public String getUsernameOrEmail()
    {
        return usernameOrEmail;
    }

    public String getPassword()
    {
        return password;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/dto/UserLoginResponseModel.java =====
package chat.ping.main.usecase.auth.dto;

public class UserLoginResponseModel
{
    private final String authToken;
    private final String username;
    private final String message;

    public UserLoginResponseModel(String authToken, String username, String message)
    {
        this.authToken = authToken;
        this.username = username;
        this.message = message;
    }

    public String getMessage()
    {
        return message;
    }

    public String getAuthToken()
    {
        return authToken;
    }

    public String getUsername()
    {
        return username;
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/register/UserRegisterOutputBoundary.java =====
package chat.ping.main.usecase.auth.register;

import chat.ping.main.entity.user.User;


/**
 * Output boundary for the User Registration use case.
 * Defines methods for preparing responses for different scenarios.
 */
public interface UserRegisterOutputBoundary
{

    /**
     * Prepares the success response view for user registration.
     *
     * @param user The registered user entity.
     */
    void prepareSuccessView(User user);

    /**
     * Prepares the error response view when the username is already taken.
     *
     * @param username The username that is already taken.
     */
    void prepareUsernameAlreadyExistsView(String username);

    /**
     * Prepares the error response view when the email is already registered.
     *
     * @param email The email that is already registered.
     */
    void prepareEmailAlreadyExistsView(String email);

    /**
     * Prepares the error response view for an invalid password.
     *
     * @param errorMessage A detailed error message describing the issue.
     */
    void prepareInvalidPasswordView(String errorMessage);

    /**
     * Prepares the error response view for an invalid email format.
     *
     * @param email The email that has an invalid format.
     */
    void prepareInvalidEmailFormatView(String email);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/register/exceptionHandler/UserAlreadyExistsHandler.java =====
package chat.ping.main.usecase.auth.register.exceptionHandler;

import chat.ping.main.entity.user.exception.UserAlreadyExistsException;
import chat.ping.main.shared.error.ErrorResponse;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class UserAlreadyExistsHandler
{
    @ExceptionHandler(UserAlreadyExistsException.class)
    public ResponseEntity<ErrorResponse> handleUserAlreadyExistsException(UserAlreadyExistsException ex)
    {
        ErrorResponse errorResponse = new ErrorResponse(
                "UserAlreadyExists",
                ex.getMessage()
        );
        return new ResponseEntity<>(errorResponse, HttpStatus.CONFLICT);
    }

}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/register/exceptionHandler/InvalidPasswordHandler.java =====
package chat.ping.main.usecase.auth.register.exceptionHandler;


import chat.ping.main.entity.user.exception.InvalidCredentialsException;
import chat.ping.main.entity.user.exception.InvalidPasswordException;
import chat.ping.main.shared.error.ErrorResponse;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class InvalidPasswordHandler
{
    @ExceptionHandler(InvalidPasswordException.class)
    public ResponseEntity<ErrorResponse> handleInvalidPasswordException(InvalidPasswordException ex)
    {
        ErrorResponse errorResponse = new ErrorResponse(
                "Invalid Password",
                ex.getMessage()
        );
        return new ResponseEntity<>(errorResponse, HttpStatus.UNAUTHORIZED);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/register/UserRegisterInteractor.java =====
package chat.ping.main.usecase.auth.register;

import chat.ping.main.entity.user.User;
import chat.ping.main.entity.user.UserFactory;
import chat.ping.main.entity.user.exception.UserAlreadyExistsException;
import chat.ping.main.infrastructure.auth.gateway.UserAuthDsGateway;
import chat.ping.main.shared.validation.EmailValidator;
import chat.ping.main.shared.validation.PasswordValidator;
import chat.ping.main.usecase.auth.dto.UserRegisterRequestModel;
import chat.ping.main.usecase.auth.dto.UserRegisterResponseModel;

public class UserRegisterInteractor implements UserRegisterInputBoundary
{
    private final UserAuthDsGateway userAuthDsGateway;
    private final UserRegisterOutputBoundary presenter;
    private final UserFactory userFactory;

    public UserRegisterInteractor(UserAuthDsGateway userAuthDsGateway,
                                  UserRegisterOutputBoundary presenter,
                                  UserFactory userFactory)
    {
        this.userAuthDsGateway = userAuthDsGateway;
        this.presenter = presenter;
        this.userFactory = userFactory;
    }

    @Override
    public void register(UserRegisterRequestModel requestModel)
    {
        // make sure username us unique
        if (userAuthDsGateway.existsByUsername(requestModel.getUsername()))
        {
            presenter.prepareUsernameAlreadyExistsView(requestModel.getUsername());
            return;
        }

        // make sure email is unique
        if (userAuthDsGateway.existsByEmail(requestModel.getEmail()))
        {
            presenter.prepareEmailAlreadyExistsView(requestModel.getEmail());
            return;
        }

        // Validate the email format
        if (!EmailValidator.isValid(requestModel.getEmail()))
        {
            presenter.prepareInvalidEmailFormatView(requestModel.getEmail());
            return;
        }


        // Validate the password
        try
        {
            PasswordValidator.isValid(requestModel.getPassword());
        } catch (IllegalArgumentException e)
        {
            presenter.prepareInvalidPasswordView(e.getMessage());
            return;
        }

        User newUser = userFactory.createUser(
                requestModel.getEmail(),
                requestModel.getUsername(),
                requestModel.getPassword()
        );

        userAuthDsGateway.save(newUser);

        // Prepare the success view
        presenter.prepareSuccessView(newUser);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/register/UserRegisterInputBoundary.java =====
package chat.ping.main.usecase.auth.register;

import chat.ping.main.usecase.auth.dto.UserRegisterRequestModel;
import chat.ping.main.usecase.auth.dto.UserRegisterResponseModel;

public interface UserRegisterInputBoundary
{
    void register(UserRegisterRequestModel requestModel);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/login/UserLoginInputBoundary.java =====
package chat.ping.main.usecase.auth.login;

import chat.ping.main.usecase.auth.dto.UserLoginRequestModel;
import chat.ping.main.usecase.auth.dto.UserLoginResponseModel;

public interface UserLoginInputBoundary
{
    void login(UserLoginRequestModel requestModel);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/login/UserLoginOutputBoundary.java =====
package chat.ping.main.usecase.auth.login;

import chat.ping.main.usecase.auth.dto.UserLoginResponseModel;

public interface UserLoginOutputBoundary
{
    void prepareSuccessView(String authToken,String username);

    void prepareInvalidCredentialsView(String errorMessage);
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/login/exceptionHandler/InvalidTokenHandler.java =====
package chat.ping.main.usecase.auth.login.exceptionHandler;


import chat.ping.main.infrastructure.security.exception.InvalidTokenException;
import chat.ping.main.shared.error.ErrorResponse;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class InvalidTokenHandler
{
    @ExceptionHandler(InvalidTokenException.class)
    public ResponseEntity<ErrorResponse> handleInvalidTokenException(InvalidTokenException ex)
    {
        ErrorResponse errorResponse = new ErrorResponse("InvalidToken", ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.UNAUTHORIZED);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/login/exceptionHandler/UserNotFoundHandler.java =====
package chat.ping.main.usecase.auth.login.exceptionHandler;

import chat.ping.main.entity.user.exception.UserNotFoundException;
import chat.ping.main.shared.error.ErrorResponse;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;


@RestControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class UserNotFoundHandler
{
    @ExceptionHandler(UserNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleUserNotFoundException(UserNotFoundException ex)
    {
        ErrorResponse errorResponse = new ErrorResponse("UserNotFound", ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.NOT_FOUND);
    }
}


===== /Users/mg/IdeaProjects/PingServer/src/main/java/chat/ping/main/usecase/auth/login/UserLoginInteractor.java =====
package chat.ping.main.usecase.auth.login;

import chat.ping.main.entity.user.User;
import chat.ping.main.entity.user.exception.InvalidCredentialsException;
import chat.ping.main.infrastructure.auth.gateway.UserAuthDsGateway;
import chat.ping.main.infrastructure.security.JWTUtils;
import chat.ping.main.shared.validation.EmailValidator;
import chat.ping.main.usecase.auth.dto.UserLoginRequestModel;
import chat.ping.main.usecase.auth.dto.UserLoginResponseModel;
import org.springframework.security.crypto.password.PasswordEncoder;
import java.util.Map;


public class UserLoginInteractor implements UserLoginInputBoundary
{
    private final UserAuthDsGateway userAuthDsGateway;
    private final PasswordEncoder passwordEncoder;
    private final UserLoginOutputBoundary presenter;
    private final JWTUtils jwtUtils;

    public UserLoginInteractor(UserAuthDsGateway userAuthDsGateway,
                               PasswordEncoder passwordEncoder,
                               UserLoginOutputBoundary presenter,
                               JWTUtils jwtUtils)
    {
        this.userAuthDsGateway = userAuthDsGateway;
        this.passwordEncoder = passwordEncoder;
        this.jwtUtils = jwtUtils;
        this.presenter = presenter;
    }

    @Override
    public void login(UserLoginRequestModel requestModel)
    {
        // identify if the login is being done by the username or password
        String usernameOrEmail = requestModel.getUsernameOrEmail();

        User user;
        // if it is an email
        if (EmailValidator.isValid(usernameOrEmail))
        {
            // then it must be an email
            user = userAuthDsGateway.findByEmail(requestModel.getUsernameOrEmail())
                    .orElseThrow(() -> new InvalidCredentialsException("Invalid username/email or password."));

        } else
        {
            user = userAuthDsGateway.findByUsername(requestModel.getUsernameOrEmail())
                    .orElseThrow(() -> new InvalidCredentialsException("Invalid username/email or password."));
        }

        // Verify Password
        if (!passwordEncoder.matches(requestModel.getPassword(), user.getPasswordHash())) {
            throw new InvalidCredentialsException("Invalid username/email or password.");
        }

        // Generate JWT token
        String authToken = jwtUtils.generateToken(user.getUsername(), Map.of());

        // return the success view
        return presenter.prepareSuccessView(user, authToken);
    }

}


